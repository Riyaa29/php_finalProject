CREATE DATABASE kidsGames; 

USE kidsGames;

CREATE TABLE player( 
    username VARCHAR(20) NOT NULL UNIQUE,
    email VARCHAR(191) NOT NULL UNIQUE,
    password VARCHAR(191) NOT NULL,
    full_name VARCHAR(100) NOT NULL, 
    phone_number VARCHAR(20) NOT NULL,
    registrationTime DATETIME NOT NULL,
    id VARCHAR(200) GENERATED ALWAYS AS (CONCAT(UPPER(LEFT(full_name,2)),UPPER(LEFT(username,3)),CAST(registrationTime AS SIGNED))),
    registrationOrder INTEGER AUTO_INCREMENT,
    PRIMARY KEY (registrationOrder)
)CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci; 

CREATE TABLE user_authenticator(   
    username VARCHAR(20) NOT NULL UNIQUE,
    passCode VARCHAR(255) NOT NULL,
    registrationOrder INTEGER, 
    FOREIGN KEY (registrationOrder) REFERENCES player(registrationOrder)
)CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci; 

CREATE TABLE score( 
    scoreTime DATETIME NOT NULL, 
    result ENUM('success', 'failure', 'incomplete'),
    livesUsed INTEGER NOT NULL,
    registrationOrder INTEGER, 
    FOREIGN KEY (registrationOrder) REFERENCES player(registrationOrder)
)CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci; 

CREATE VIEW history AS
SELECT s.scoreTime, p.id, p.full_name, s.result, s.livesUsed 
FROM player p, score s
WHERE p.registrationOrder = s.registrationOrder;

ALTER TABLE player ADD COLUMN numLives INTEGER NOT NULL DEFAULT 6;

CREATE TRIGGER decrement_lives AFTER INSERT ON score
FOR EACH ROW
BEGIN
    UPDATE player SET numLives = numLives - 1 WHERE registrationOrder = NEW.registrationOrder AND NEW.result <> 'success';
END;
